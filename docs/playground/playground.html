<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>axo playground!</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        textarea {
            width: 100%;
            height: 200px;
        }
        #output {
            margin-top: 20px;
            white-space: pre-wrap;
            background: #f0f0f0;
            padding: 10px;
        }
    </style>
    <script>
        var axo_errors = [];
    </script>
    <script type="module">
        import initModule from './playground.js';

        async function runCode() {
            const axo_code = document.getElementById('code').value;
            const outputDiv = document.getElementById('output');
            outputDiv.textContent = 'Running...';

            // Ensure the WebAssembly module is initialized
            const Module = await initModule();

            // Wrap and call the compiled C function
            var js_wrapped_compile = Module.cwrap("axo_compile_to_c", "string", ["string"]);
            var c_code = js_wrapped_compile(axo_code);

            // Check if axo_errors array is not empty
            if (axo_errors.length > 0) {
                outputDiv.textContent = "";
                axo_errors.forEach(function(error, index) {
                    outputDiv.textContent += `${error}`;
                });
                axo_errors = [];
                return; // Skip the Piston API call
            }

            try {
                const response = await fetch('https://emkc.org/api/v2/piston/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        language: 'c',
                        version: '10.2.0',  // Use the latest version of the C compiler
                        files: [{
                            name: 'main',
                            content: c_code
                        }]
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Network response was not ok');
                }

                if (result.run.code !== 0) {
                    outputDiv.textContent = `Error: ${result.run.stderr}`;
                } else {
                    outputDiv.textContent = result.run.output;
                }
            } catch (error) {
                outputDiv.textContent = `Error: ${error.message}`;
            }
        }

        document.querySelector('button').onclick = runCode;
    </script>
</head>
<body>
    <h1>axo playground</h1>
    <textarea id="code" placeholder="Enter your axo code here..."></textarea>
    <br>
    <button>Run</button>
    <div id="output"></div>
</body>
</html>
