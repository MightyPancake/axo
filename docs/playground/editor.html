<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>axo playground</title>
  	<link rel="stylesheet" href="https://prismjs.com/themes/prism.css">
    <link rel="stylesheet" href="https://prismjs.com/plugins/line-numbers/prism-line-numbers.css">
    <link rel="stylesheet" href="editor.css">
  </head>
  <body>
    <div id="main">
      <h1>Code playground</h1>
      <div class="buttons">
        <button id="run-button">Run</button>
        <button id="share-button">Share</button>
      </div>
      <textarea id="editor" class="prism-live language-axo line-numbers fill" spellcheck="false">
use std
use io

//Main entry point
fn main(){
  printf("hello world!\n")
  ret 0
}
</textarea>
    <h3 class="output-label">Output:</h3>
    <div id="output"></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/prism.min.js"></script>
    <script src="https://prismjs.com/plugins/line-numbers/prism-line-numbers.js"></script>
    <script src="../axo-syntax-highlighting.js"></script>
    <script src = "https://live.prismjs.com/src/prism-live.js"</script>
    <script>
      PrismLive.registerLanguage("axo", Prism.languages.axo)
      PrismLive.update();
      document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', () => {
          textarea.classList.add('line-numbers');
          Prism.highlightElement(textarea);
        });
      });
    </script>
    <script>
        var axo_errors = [];
    </script>
    <script type="module">
        import initModule from './playground.js';

        async function runCode() {
            const axo_code = document.getElementById('editor').value;
            const outputDiv = document.getElementById('output');
            outputDiv.textContent = 'Running...';
            const Module = await initModule();
            var js_wrapped_compile = Module.cwrap("axo_compile_to_c", "string", ["string"]);
            var c_code = js_wrapped_compile(axo_code);
            // Check if axo_errors array is not empty
            if (axo_errors.length > 0) {
                outputDiv.textContent = "";
                axo_errors.forEach(function(error, index) {
                    outputDiv.textContent += `${error}`;
                });
                axo_errors = [];
                return;
            }

            try {
                const response = await fetch('https://emkc.org/api/v2/piston/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        language: 'c',
                        version: '10.2.0',  // Use the latest version of the C compiler
                        files: [{
                            name: 'main',
                            content: c_code
                        }]
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Network response was not ok');
                }

                if (result.run.code !== 0) {
                    outputDiv.textContent = `Error: ${result.run.stderr}`;
                } else {
                    outputDiv.textContent = result.run.output;
                }
            } catch (error) {
                outputDiv.textContent = `Error: ${error.message}`;
            }
        }

        function shareCode() {
            const editorContent = document.getElementById('editor').value;
            const encodedCode = encodeURIComponent(editorContent);
            const currentUrl = window.location.href.split('?')[0]; // Remove existing query parameters
            const params = new URLSearchParams();
            params.set('code', encodedCode);
            const shareableURL = `${currentUrl}?${params.toString()}`;

            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = shareableURL;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            tempTextarea.setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
                alert('Link copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy link: ', err);
            }

            document.body.removeChild(tempTextarea);
        }

        async function loadCodeFromURL() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code) {
                try {
                    const decodedCode = decodeURIComponent(code);
                    document.getElementById('editor').value = decodedCode;
                    PrismLive.update();
                } catch (err) {
                    console.error('Failed to decode code from URL: ', err);
                }
            }
        }

        loadCodeFromURL();
        document.getElementById('share-button').onclick = shareCode;
        document.getElementById('run-button').onclick = runCode;
    </script>
  </body>
</html>
