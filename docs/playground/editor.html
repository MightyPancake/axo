<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Run axo online!</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="../axo-syntax-highlighting.js"></script> <!-- Your custom grammar file -->
</head>
<body>
    <h1>Code playground</h1>
    <div id="editor-container">
        <div id="line-numbers"></div>
        <div id="editor-container-inner">
            <div id="highlighted-text"></div>
            <div id="editor" contenteditable="true" spellcheck="false"></div>
        </div>
    </div>
    <div>
        <button id="run-button">Run</button>
        <button id="share-button">Share</button>
    </div>
    <h3>Output:</h3>
    <div id="output"></div>
    <script>
        const editor = document.getElementById('editor');
        const highlightedText = document.getElementById('highlighted-text');
        const lineNumbers = document.getElementById('line-numbers');
        editor.addEventListener('input', updateLineNumbersAndHighlight);
        editor.addEventListener('scroll', syncScroll);
        editor.addEventListener('keydown', function(event) {
            if (event.key === 'Tab') {
                event.preventDefault();
                insertTab();
            } else if (event.key === 'Enter') {
                event.preventDefault();
                insertNewLine();
            }
        });
        editor.addEventListener('paste', function(event) {
            event.preventDefault(); // Prevent default paste behavior

            const clipboardData = event.clipboardData || window.clipboardData;
            const text = clipboardData.getData('text/plain'); // Get plain text from clipboard

            document.execCommand('insertText', false, text);

            updateLineNumbersAndHighlight();
        });

        function updateLineNumbersAndHighlight() {
            updateLineNumbers();
            updateHighlightedText();
        }

        function updateLineNumbers() {
            const text = editor.innerText;
            var lineCount = (text.match(/\n/g) || []).length + 1;
            lineNumbers.innerHTML = Array.from({ length: lineCount }, () => `<div></div>`).join(''); // Create empty divs
        }

        function updateHighlightedText() {
            const code = editor.innerText;
            const highlighted = Prism.highlight(code, Prism.languages.axo, 'axo');
            highlightedText.innerHTML = highlighted;
        }

        function insertTab() {
            const sel = window.getSelection();
            const range = sel.getRangeAt(0);
            const tabNode = document.createTextNode('\t');
            range.deleteContents();
            range.insertNode(tabNode);
            range.setStartAfter(tabNode);
            range.setEndAfter(tabNode);
            sel.removeAllRanges();
            sel.addRange(range);
            updateLineNumbersAndHighlight();
        }

        function insertNewLine() {
            const sel = window.getSelection();
            const range = sel.getRangeAt(0);
            const newTextNode = document.createTextNode('\n'); // Create a new text node with newline character

            range.deleteContents(); // Remove existing content in the selection
            range.insertNode(newTextNode); // Insert the newline character
            range.setStartAfter(newTextNode); // Set the range to start after the new text node
            range.setEndAfter(newTextNode); // Set the range to end after the new text node
            sel.removeAllRanges();
            sel.addRange(range);
            updateLineNumbersAndHighlight();
        }

        function syncScroll() {
            highlightedText.scrollTop = editor.scrollTop;
            highlightedText.scrollLeft = editor.scrollLeft;
            lineNumbers.scrollTop = editor.scrollTop; // Sync line numbers scroll
            lineNumbers.scrollLeft = editor.scrollLeft; // Optional: sync horizontal scroll if needed
        }
        updateLineNumbersAndHighlight();
    </script>
    <script>
        var axo_errors = [];
    </script>
    <script type="module">
        import initModule from './playground.js';

        function getTextWithNewlines(element) {
            let text = '';
            const nodes = element.childNodes;

            nodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE) {
                    text += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'BR') {
                    text += '\n';
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // Recursively handle nested elements
                    text += getTextWithNewlines(node);
                }
            });

            return text;
        }

        async function runCode() {
            const axo_code = getTextWithNewlines(document.getElementById('editor'));
            const outputDiv = document.getElementById('output');
            outputDiv.textContent = 'Running...';

            // Ensure the WebAssembly module is initialized
            const Module = await initModule();

            // Wrap and call the compiled C function
            var js_wrapped_compile = Module.cwrap("axo_compile_to_c", "string", ["string"]);
            var c_code = js_wrapped_compile(axo_code);

            // Check if axo_errors array is not empty
            if (axo_errors.length > 0) {
                outputDiv.textContent = "";
                axo_errors.forEach(function(error, index) {
                    outputDiv.textContent += `${error}`;
                });
                axo_errors = [];
                return; // Skip the Piston API call
            }

            try {
                const response = await fetch('https://emkc.org/api/v2/piston/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        language: 'c',
                        version: '10.2.0',  // Use the latest version of the C compiler
                        files: [{
                            name: 'main',
                            content: c_code
                        }]
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Network response was not ok');
                }

                if (result.run.code !== 0) {
                    outputDiv.textContent = `Error: ${result.run.stderr}`;
                } else {
                    outputDiv.textContent = result.run.output;
                }
            } catch (error) {
                outputDiv.textContent = `Error: ${error.message}`;
            }
        }


        document.getElementById('run-button').onclick = runCode;
        document.getElementById('share-button').addEventListener('click', function() {
            const code = getTextWithNewlines(document.getElementById('editor'));
            const encodedCode = encodeURIComponent(code); // Properly encode the code
            const baseURL = window.location.href.split('?')[0]; // Remove existing query parameters
            const shareURL = `${baseURL}?code=${encodedCode}`;
    
            // Create a temporary textarea element to hold the share URL
            const textArea = document.createElement('textarea');
            textArea.value = shareURL;
            document.body.appendChild(textArea);
            textArea.select();
    
            let successful = false;

            // Attempt to use the Clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareURL)
                    .then(() => {
                        successful = true;
                        alert('Link copied to clipboard!');
                    })
                    .catch(err => {
                        console.error('Failed to copy link with Clipboard API: ', err);
                        // Fallback to execCommand if Clipboard API fails
                        document.execCommand('copy');
                    })
                    .finally(() => {
                        document.body.removeChild(textArea);
                    });
            } else {
                // Fallback to execCommand if Clipboard API is not available
                document.execCommand('copy');
                successful = true;
                document.body.removeChild(textArea);
                alert('Link copied to clipboard!');
            }

            if (!successful) {
                alert('Failed to copy link to clipboard.');
            }
        });
        window.addEventListener('load', () => {
            try {
                // Get the URL and search for the 'code' parameter
                const url = window.location.href;
                const codeParamMatch = url.match(/[?&]code=([^&#]*)/);
        
                if (codeParamMatch) {
                    // Decode the code parameter value
                    let encodedCode = codeParamMatch[1].replace(/\+/g, ' ');
                    let decodedCode = decodeURIComponent(encodedCode);
            
                    // Find the editor element and set the code
                    const editor = document.getElementById('editor');
                    if (editor) {
                        editor.textContent = decodedCode;
                
                        // Update the line numbers and syntax highlighting
                        updateLineNumbersAndHighlight();
                    } else {
                        console.error('Editor element not found');
                    }
                } else {
                    console.error('No code parameter found in the URL');
                }
            } catch (e) {
                console.error('Failed to load the code from the URL:', e);
            }
        });
    </script>
</body>
</html>
